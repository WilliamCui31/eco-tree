<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>苍穹生态树</title>
    <link rel="stylesheet" href="./styles/normalize.css" />
    <link rel="stylesheet" href="./styles/odometer-theme-train-station.css" />
    <link rel="stylesheet" href="./styles/eco-tree.css" />
  </head>
  <body>
    <div class="background">
      <div class="background-tree">
        <img id="tree" alt="苍穹生态树" />
      </div>
      <canvas id="canvas"></canvas>
      <div class="cloud-container">
        <img id="cloudStar" class="cloud-star" src="./images/cloud_star.svg" alt="金蝶云生态树" />
      </div>
      <div id="lottie"></div>
    </div>
    <div id="app">
      <main class="content">
        <div class="interactive">
          <div class="partner-box">
            <ul class="partner-list">
              <li
                v-for="(item, index) in currentPartnerList"
                @mouseenter="handleMouseEnter(index)"
                @mouseleave="handleMouseLeave"
                :class="`level${item.partnerLevel}${fadeIn ? ' fade-in' : ''}${item && partnerInfo && item.id === partnerInfo.id ? ' current' : ''}`"
                :style="`left: ${item.left/10}rem; top: ${item.top/10}rem; width: ${item.size/10}rem; height: ${item.size/10}rem;`"
              >
                <img
                  v-if="item.partnerLogo"
                  :src="'/api/public/file/'+item.partnerLogo"
                  :alt="item.name"
                />
              </li>
            </ul>
            <div
              v-if="partnerInfo"
              :class="`partner-info level${partnerInfo.partnerLevel}${infoFadeIn ? ' fade-in' : ''}`"
            >
              <h3 class="partner-level">
                <img
                  v-if="partnerInfo.partnerLevel"
                  :src="`./images/icon_partner_level${partnerInfo.partnerLevel}@${dpr}x.png`"
                  alt="伙伴等级"
                />
                ISV生态伙伴
                <!-- {{partnerInfo.partnerLevel == 1 ? '生态战略伙伴' :
                partnerInfo.partnerLevel == 2 ? '生态金牌伙伴' : '生态伙伴'}} -->
              </h3>
              <header class="partner-header">
                <div class="partner-avatar">
                  <img
                    v-if="partnerInfo.partnerLogo"
                    :src="'/api/public/file/'+partnerInfo.partnerLogo"
                    :alt="partnerInfo.name"
                  />
                </div>
                <h3 class="partner-title">
                  {{partnerInfo.name}}
                </h3>
              </header>
              <p class="partner-detail">
                深圳市莫亚科技有限公司（以下简称"莫亚科技"）于2010年在深圳正式成立，注册资金500万人民币，目前拥有深圳、长沙两大技术研发中心。莫亚科技是国内一流的金蝶EAS平台软件定制及服务提供商，金蝶钻石级的交付合作伙伴。
              </p>
              <div class="partner-app">
                <h3 class="partner-app-title">
                  <svg
                    width="16px"
                    height="16px"
                    viewBox="0 0 16 16"
                    version="1.1"
                    xmlns="http://www.w3.org/2000/svg"
                    xmlns:xlink="http://www.w3.org/1999/xlink"
                  >
                    <title>应用</title>
                    <desc>Created with Sketch.</desc>
                    <defs>
                      <rect id="path-1" x="0" y="0" width="16" height="16"></rect>
                    </defs>
                    <g id="页面-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                      <g id="形状结合备份-2">
                        <mask id="mask-2" fill="white">
                          <use xlink:href="#path-1"></use>
                        </mask>
                        <g id="蒙版"></g>
                        <path
                          d="M13.7040046,9.70304636 L16.815861,12.8149028 C17.0613797,13.0604214 17.0613797,13.4584859 16.815861,13.7040046 L13.7040046,16.815861 C13.4584859,17.0613797 13.0604214,17.0613797 12.8149028,16.815861 L9.70304636,13.7040046 C9.45752767,13.4584859 9.45752767,13.0604214 9.70304636,12.8149028 L12.8149028,9.70304636 C13.0604214,9.45752767 13.4584859,9.45752767 13.7040046,9.70304636 Z M7.28689932,9.80165905 C7.63411518,9.80165905 7.91558925,10.0831331 7.91558925,10.430349 L7.91558925,16.0885584 C7.91558925,16.4357742 7.63411518,16.7172483 7.28689932,16.7172483 L1.62868993,16.7172483 C1.28147407,16.7172483 1,16.4357742 1,16.0885584 L1,10.430349 C1,10.0831331 1.28147407,9.80165905 1.62868993,9.80165905 L7.28689932,9.80165905 Z M7.28689932,1 C7.63411518,1 7.91558925,1.28147407 7.91558925,1.62868993 L7.91558925,7.28689932 C7.91558925,7.63411518 7.63411518,7.91558925 7.28689932,7.91558925 L1.62868993,7.91558925 C1.28147407,7.91558925 1,7.63411518 1,7.28689932 L1,1.62868993 C1,1.28147407 1.28147407,1 1.62868993,1 L7.28689932,1 Z M16.0885584,1 C16.4357742,1 16.7172483,1.28147407 16.7172483,1.62868993 L16.7172483,7.28689932 C16.7172483,7.63411518 16.4357742,7.91558925 16.0885584,7.91558925 L10.430349,7.91558925 C10.0831331,7.91558925 9.80165905,7.63411518 9.80165905,7.28689932 L9.80165905,1.62868993 C9.80165905,1.28147407 10.0831331,1 10.430349,1 L16.0885584,1 Z"
                          fill="#0AD5D4"
                          mask="url(#mask-2)"
                        ></path>
                      </g>
                    </g>
                  </svg>
                  {{partnerInfo.productName || '默认应用'}}
                </h3>
                <p class="partner-app-detail">
                  基于移动互联网时代的在线订单跟踪处理几企业内部流程管理于一体的企业Saas服务平台，致力于帮助企业快速构建自己专属的在线销售。
                </p>
              </div>
            </div>
          </div>
          <button class="interactive-light" v-if="!isLightUp" @click="handleLightUp">
            <img :src="`./images/icon_light@${dpr}x.png`" alt="点亮生态树" />
            助力生态树
          </button>
          <p class="interactive-tips" v-if="!isLightUp">
            每位用户点亮生态树<br />即为生态树提供100的能量值
          </p>
          <div class="interactive-counts">
            <div class="interactive-slogan"><img :src="`./images/slogan@${dpr}x.png`" alt="金蝶云生态" /></div>
            <div class="counts-energy">
              <h4>生态树能量值</h4>
              <strong ref="energyValue"></strong>
              <span
                :class="`counts-energy-effect ${isLightUp ? ' lightup' : ''}`"
                ref="addEnergyEffect"
                >+100</span
              >
            </div>
            <!-- <div class="counts-cont">
              <div class="counts-partner">
                <h4>
                  <svg
                    width="18px"
                    height="18px"
                    viewBox="0 0 18 18"
                    version="1.1"
                    xmlns="http://www.w3.org/2000/svg"
                    xmlns:xlink="http://www.w3.org/1999/xlink"
                  >
                    <title>伙伴数</title>
                    <desc>Created with Sketch.</desc>
                    <g
                      id="页面-1"
                      stroke="none"
                      stroke-width="1"
                      fill="none"
                      fill-rule="evenodd"
                      opacity="0.800000012"
                    >
                      <g id="画板" transform="translate(-1593.000000, -199.000000)" fill="#FFFFFF">
                        <g id="编组-13备份-4" transform="translate(1593.000000, 199.000000)">
                          <path
                            d="M12.24,1.44 C14.2282251,1.44 15.84,3.0517749 15.84,5.04 C15.84,6.39170264 15.0950354,7.56940948 13.9932817,8.18494518 C16.3172404,8.90550093 18,11.0218275 18,13.5202857 C18,14.3813466 17.1071599,15.0026928 15.8186032,15.3843245 C15.8333682,15.2748509 15.84,15.1623674 15.84,15.0476364 L15.8372189,14.8289334 C15.7631922,11.9205575 14.2168092,9.32526209 11.8523067,7.82597465 L11.79648,7.79112 L11.877924,7.68181038 C12.5660823,6.72459197 12.96,5.5573556 12.96,4.32 C12.96,3.27131641 12.6797522,2.2880882 12.1900638,1.44112266 L12.24,1.44 L12.24,1.44 Z"
                            id="形状结合"
                          ></path>
                          <path
                            d="M7.2,0 C9.58587012,0 11.52,1.93412988 11.52,4.32 C11.52,6.00926858 10.5504071,7.4720766 9.13738147,8.18226373 C12.1731268,9.01888701 14.4,11.7758183 14.4,15.0476364 C14.4,18.9841212 0,18.9841212 0,15.0476364 C0,11.7758183 2.22687322,9.01888701 5.26204309,8.18116156 C3.84959295,7.4720766 2.88,6.00926858 2.88,4.32 C2.88,1.93412988 4.81412988,0 7.2,0 Z"
                            id="形状结合"
                          ></path>
                        </g>
                      </g>
                    </g>
                  </svg>
                  总伙伴数
                </h4>
                <strong class="counts-numbers">5000+</strong>
              </div>
              <div class="counts-developer">
                <h4>
                  <svg
                    width="18px"
                    height="18px"
                    viewBox="0 0 18 18"
                    version="1.1"
                    xmlns="http://www.w3.org/2000/svg"
                    xmlns:xlink="http://www.w3.org/1999/xlink"
                  >
                    <title>开发者人数</title>
                    <desc>Created with Sketch.</desc>
                    <defs>
                      <rect id="path-1" x="0" y="0" width="18" height="18"></rect>
                    </defs>
                    <g
                      id="页面-1"
                      stroke="none"
                      stroke-width="1"
                      fill="none"
                      fill-rule="evenodd"
                      opacity="0.800000012"
                    >
                      <g id="画板" transform="translate(-1593.000000, -301.000000)">
                        <g
                          id="矩形-+-路径-60备份-+-路径-60备份-2-+-路径-17-蒙版备份"
                          transform="translate(1593.000000, 301.000000)"
                        >
                          <mask id="mask-2" fill="white">
                            <use xlink:href="#path-1"></use>
                          </mask>
                          <g id="蒙版"></g>
                          <path
                            d="M17,0 C17.5522847,-1.01453063e-16 18,0.44771525 18,1 L18,13 C18,13.5522847 17.5522847,14 17,14 L1,14 C0.44771525,14 6.76353751e-17,13.5522847 0,13 L0,1 C-6.76353751e-17,0.44771525 0.44771525,1.01453063e-16 1,0 L17,0 Z M11.0110913,3.46966991 C10.7448247,3.73593648 10.7206187,4.15260016 10.9384731,4.44621165 L11.0110913,4.53033009 L13.4804214,7 L11.0110913,9.46966991 C10.7448247,9.73593648 10.7206187,10.1526002 10.9384731,10.4462117 L11.0110913,10.5303301 C11.2773578,10.7965966 11.6940215,10.8208027 11.987633,10.6029482 L12.0717514,10.5303301 L15.0010408,7.60104076 C15.3053243,7.29675725 15.3306812,6.819171 15.0771116,6.4860037 L15.0010408,6.39895924 L12.0717514,3.46966991 C11.7788582,3.1767767 11.3039845,3.1767767 11.0110913,3.46966991 Z M7.03033009,3.46966991 C6.73743687,3.1767767 6.26256313,3.1767767 5.96966991,3.46966991 L5.96966991,3.46966991 L3.04038059,6.39895924 L2.96430971,6.4860037 C2.71074012,6.819171 2.73609708,7.29675725 3.04038059,7.60104076 L3.04038059,7.60104076 L5.96966991,10.5303301 L6.05378835,10.6029482 C6.34739984,10.8208027 6.76406352,10.7965966 7.03033009,10.5303301 L7.03033009,10.5303301 L7.10294824,10.4462117 C7.3208027,10.1526002 7.29659665,9.73593648 7.03033009,9.46966991 L7.03033009,9.46966991 L4.561,7 L7.03033009,4.53033009 L7.10294824,4.44621165 C7.3208027,4.15260016 7.29659665,3.73593648 7.03033009,3.46966991 Z"
                            id="形状结合"
                            fill="#FFFFFF"
                            mask="url(#mask-2)"
                          ></path>
                          <path
                            d="M15,15.5 C15.5522847,15.5 16,15.9477153 16,16.5 C16,17.0128358 15.6139598,17.4355072 15.1166211,17.4932723 L15,17.5 L3,17.5 C2.44771525,17.5 2,17.0522847 2,16.5 C2,15.9871642 2.38604019,15.5644928 2.88337887,15.5067277 L3,15.5 L15,15.5 Z"
                            id="路径-17"
                            fill="#FFFFFF"
                            fill-rule="nonzero"
                            mask="url(#mask-2)"
                          ></path>
                        </g>
                      </g>
                    </g>
                  </svg>
                  总开发者人数
                </h4>
                <strong class="counts-numbers">10000+</strong>
              </div>
            </div> -->
            <div class="counts-text">
              种下生态树，万物竞长，聚力生态<br />
              金蝶愿与全球生态伙伴<br />
              携手打造共享，共赢，共生的企业云生态<br />
              祈愿“<strong>生态树</strong>”<br />
              枝繁叶茂，硕果累累<br />
            </div>
          </div>
        </div>
        <!-- <div class="description">
          <h2 class="description-slogan">
            以客户价值为中心，给生态伙伴以舞台，丰富行业场景应用
          </h2>
          <div class="description-stucture">
            <img :src="`./images/cloud_eco@${dpr}x.png`" alt="云生态" />
          </div>
          <div class="description-brand">
            <div class="description-brand-qrcode">
              <img src="./images/qrcode.png" alt="金蝶云生态" />
            </div>
            <div class="description-brand-text">
              <span>扫码加入我们</span>
              <h3>携手同行， 缔造不凡</h3>
            </div>
          </div>
          <ul class="description-feature">
            <li><img :src="`./images/icon_revenue@${dpr}x.png`" alt="" />增加营收</li>
            <li><img :src="`./images/icon_renown@${dpr}x.png`" alt="" />提高名声</li>
            <li><img :src="`./images/icon_growing@${dpr}x.png`" alt="" />助你成长</li>
            <li><img :src="`./images/icon_service@${dpr}x.png`" alt="" />为你服务</li>
          </ul>
        </div> -->
      </main>
      <!-- <footer class="footer">
        2020金蝶软件（中国）有限公司 粤ICP备05041751号-2 粤公网安备 44030502002324号
      </footer> -->
    </div>
    <script src="./scripts/lottie.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.11/vue.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/0.19.2/axios.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/odometer.js/0.4.8/odometer.min.js"></script>
    <script>
      function Star(id, x, y) {
        // id
        this.id = id;

        // 圆心坐标
        this.x = x;
        this.y = y;

        const a = Math.random();
        let b = 1;
        if (a >= 0.2 && a < 0.5) {
          b = 2;
        } else if (a >= 0.5 && a < 0.7) {
          b = 3;
        } else if (a >= 0.7 && a < 0.75) {
          b = 4;
        } else if (a >= 0.75 && a < 0.7501) {
          b = 5;
        } else if (a >= 0.76 && a < 0.7601) {
          b = 6;
        }

        // 半径
        this.r = b;

        // 发光大小
        this.shadowBlur = 0;

        // 透明度
        this.alpha = (6 + Math.random() * 4) / 10;

        // 颜色
        const colorArr = ['#2185ED', '#04CCFD', '#03C7C7', '#9F6DFF'];
        const color = colorArr[Math.floor(Math.random() * 4)];
        this.color = colorRgba(color, this.alpha);
      }

      Star.prototype.draw = function () {
        ctx.save();
        ctx.fillStyle = this.color;
        if (/^bg_/.test(this.id) || (!/^bg_/.test(this.id) && !isLightUp)) {
          ctx.shadowColor = 'white';
          ctx.shadowBlur = this.shadowBlur;
        }
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI, false);
        ctx.closePath();
        ctx.fill();
        ctx.restore();
      };

      Star.prototype.glint = function () {
        const vs = this.r * 10 * 0.01;
        const vr = this.r * 0.01;
        if (this.isBright) {
          this.shadowBlur -= vs;
          this.r -= vr;
          if (this.shadowBlur <= 1) this.isBright = false;
        } else {
          this.shadowBlur += vs;
          this.r += vr;
          if (this.shadowBlur >= 20) this.isBright = true;
        }
        this.draw();
      };

      Star.prototype.moveToTree = function () {
        const vx = (this.focusPos.x - this.x) * 0.08;
        const vy = (this.focusPos.y - this.y) * 0.08;
        if (this.x !== this.focusPos.x) this.x += vx;
        if (this.y !== this.focusPos.y) this.y += vy;
        this.draw();
      };

      Star.prototype.toTree = function () {
        this.x = this.focusPos.x;
        this.y = this.focusPos.y;
        this.draw();
      };

      const stars = [];
      const bgStars = [];
      const starNumber = 2000;
      const bgStarNumber = 200;
      const background = document.querySelector('.background');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio > 1 ? 2 : 1;
      const tree = document.getElementById('tree');
      const lottieContainer = document.getElementById('lottie');
      const cloudStar = document.getElementById('cloudStar');
      const lightUpBtn = document.getElementById('lightUpBtn');

      // 加载生态树
      tree.src = `./images/eco_tree@${dpr}x.png`;

      // 设置背景图片
      background.style.setProperty('--background-image', `url(../images/aperture@${dpr}x.png)`);

      let od,
        rafG,
        rafP,
        WIDTH,
        HEIGHT,
        treeRect,
        isLightUp = false;

      // 初始化画布和star
      tree.onload = init();

      // 窗口改变大小事件
      window.addEventListener('resize', () => {
        resizeCanvas();
        drawTree();
      });

      // 初始化函数
      function init() {
        // 初始化画布大小
        resizeCanvas();
        drawTree();

        treeRect = tree.getBoundingClientRect();
        const scrollTop = document.documentElement.scrollTop;
        const scrollLeft = document.documentElement.scrollLeft;

        // 初始化背景star
        for (let i = 0; i < bgStarNumber; i++) {
          const x = Math.floor(Math.random() * WIDTH * 2);
          const y = Math.floor(Math.random() * (background.offsetHeight - 100));

          if (
            !(
              x >= treeRect.x + scrollLeft - 20 &&
              x <= treeRect.x + treeRect.width + scrollLeft + 20 &&
              y >= treeRect.y + scrollTop - 20 &&
              y <= treeRect.y + treeRect.height + scrollTop + 20
            ) &&
            !(x > 0 && x < 200 && y > 0 && y < 100)
          ) {
            const bgStar = new Star(`bg_${i}`, x, y);
            bgStar.draw();
            bgStars.push(bgStar);
          }
        }
        console.log('bgStarNumber: ', bgStars.length);

        if (isLightUp) {
          // 显示星云
          cloudStar.className = 'lightup';

          // 背景星星闪烁
          glink();
        } else {
          // 初始化能量star
          for (let i = 0; i < starNumber; i++) {
            const directionX = Math.random() < 0.5 ? -1 : 1;
            const directionY = Math.random() < 0.5 ? -1 : 1;
            const spreadX = directionX ? 2 : 1;
            const spreadY = directionY ? 2 : 1;

            const x = directionX * Math.floor(Math.random() * WIDTH * spreadX);
            const y = directionY * Math.floor(Math.random() * (background.offsetHeight - 100));

            if (
              !(
                x >= treeRect.x + scrollLeft - 20 &&
                x <= treeRect.x + treeRect.width + scrollLeft + 20 &&
                y >= treeRect.y + scrollTop - 20 &&
                y <= treeRect.y + treeRect.height + scrollTop + 20
              ) &&
              !(x > 0 && x < 200 && y > 0 && y < 100)
            ) {
              const star = new Star(`power_${i}`, x, y);
              star.draw();
              stars.push(star);
            }
          }

          console.log('starNumber: ', stars.length);

          // 星星闪烁
          glink();

          // 点亮生态树按钮动效
          lightEffect();
        }
      }

      function drawTree() {
        treeRect = tree.getBoundingClientRect();
        const scrollTop = document.documentElement.scrollTop;
        const scrollLeft = document.documentElement.scrollLeft;
        ctx.drawImage(
          tree,
          treeRect.x + scrollLeft,
          treeRect.y + scrollTop,
          treeRect.width,
          treeRect.height,
        );
      }

      // 设置画布大小为浏览器窗口大小
      function resizeCanvas() {
        WIDTH = document.documentElement.clientWidth;
        HEIGHT = document.documentElement.clientHeight;
        canvas.setAttribute('width', WIDTH);
        canvas.setAttribute('height', background.offsetHeight);
      }

      // 根据tree的形状随机生成所有star的坐标
      function generateFousPos() {
        // tree的对star的吸附程度，值为0-1之间的值，0是完全不吸附，1是完全吸附。
        const fit = 1;
        const starsLength = stars.length;
        const fitLength = Math.floor(starsLength * fit);

        const minX = canvas.width / 2 - treeRect.width / 2;
        const minY = canvas.height / 2 - treeRect.height / 2;
        const data = ctx.getImageData(minX, minY, treeRect.width, treeRect.height * 0.9).data;

        const ableDataArr = [];
        for (var i = 0; i < data.length; i++) {
          var num = Math.floor(Math.random() * data.length);
          if (data[num]) {
            ableDataArr.push(num);
          }
        }

        for (let i = 0; i < fitLength; i++) {
          var w = Math.floor(treeRect.width);
          var num = ableDataArr[i];
          num = Math.floor(num / 4);
          var x = canvas.width / 2 - (w / 2 - (num % w));
          var y = canvas.height / 2 - (treeRect.height / 2 - Math.floor(num / w));
          stars[i].focusPos = { x, y };
        }

        for (let i = fitLength; i < starsLength; i++) {
          var x = treeRect.x + treeRect.width / 2;
          var y = treeRect.y + treeRect.height * 0.4;
          var r1 = treeRect.width / 2;
          var r2 = treeRect.height * 0.4;

          const scrollTop = document.documentElement.scrollTop;
          const scrollLeft = document.documentElement.scrollLeft;
          stars[i].focusPos = getEllipsePath(x + scrollLeft, y + scrollTop, r1, r2);
        }
      }

      // 吸附star到tree上的函数
      function polymeric() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        drawTree();

        // 背景star闪烁
        bgStars.forEach((star, index) => {
          if (star.x > 0 && star.y > 0 && star.x < WIDTH && star.y < HEIGHT) {
            star.glint();
          }
        });

        // 吸附能量star
        stars.forEach((star, index) => {
          star.moveToTree();
        });

        rafP = requestAnimationFrame(polymeric);
      }

      // 星星闪烁
      function glink() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        drawTree();

        // 背景星星闪烁
        bgStars.forEach((star, index) => {
          if (star.x > 0 && star.y > 0 && star.x < WIDTH && star.y < HEIGHT) {
            star.glint();
          }
        });

        // 能量星星闪烁
        stars.forEach((star, index) => {
          if (star.x > 0 && star.y > 0 && star.x < WIDTH && star.y < HEIGHT) {
            star.glint();
          }
        });

        rafG = requestAnimationFrame(glink);
      }

      // 背景星星闪烁
      function bgGlink() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        drawTree();

        // 背景星星闪烁
        bgStars.forEach((star, index) => {
          if (star.x > 0 && star.y > 0 && star.x < WIDTH && star.y < HEIGHT) {
            star.glint();
          }
        });

        requestAnimationFrame(bgGlink);
      }

      // 给定椭圆圆心和半径填充椭圆函数
      function getEllipsePath(x, y, r1, r2) {
        let R1 = r1 * Math.random();
        let R2 = r2 * Math.random();
        let theta = Math.random() * 2 * Math.PI;
        targetX = x + R1 * Math.cos(theta);
        targetY = y + R2 * Math.sin(theta);
        return { x: targetX, y: targetY };
      }

      // 十六进制颜色值转rgba
      function colorRgba(sHex, alpha) {
        // 十六进制颜色值的正则表达式
        var reg = /^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;
        /* 16进制颜色转为RGB格式 */
        let sColor = sHex.toLowerCase();
        if (sColor && reg.test(sColor)) {
          if (sColor.length === 4) {
            var sColorNew = '#';
            for (let i = 1; i < 4; i += 1) {
              sColorNew += sColor.slice(i, i + 1).concat(sColor.slice(i, i + 1));
            }
            sColor = sColorNew;
          }
          // 处理六位的颜色值
          var sColorChange = [];
          for (let i = 1; i < 7; i += 2) {
            sColorChange.push(parseInt('0x' + sColor.slice(i, i + 2)));
          }
          return 'rgba(' + sColorChange.join(',') + ',' + alpha + ')';
        } else {
          return sColor;
        }
      }

      // 防抖函数
      function debounce(fn, wait) {
        let timer = null;
        return function () {
          if (timer !== null) clearTimeout(timer);
          timer = setTimeout(fn, wait);
        };
      }

      // 点亮生态树按钮动效
      function lightEffect() {
        axios.get('./scripts/data.json').then((response) => {
          if (response.status === 200) {
            var params = {
              container: lottieContainer,
              renderer: 'svg',
              loop: true,
              autoplay: true,
              animationData: response.data,
            };
            lottie.loadAnimation(params);
          }
        });
      }

      new Vue({
        el: '#app',
        data: {
          devCounts: 0,
          partnerCounts: 0,
          partnerList: [],
          currentRound: 0,
          fadeIn: false,
          infoFadeIn: false,
          timer1: null,
          timer2: null,
          timer3: null,
          currentPartnerList: [],
          partnerIndex: 0,
          partnerInfo: {},
          isLightUp: isLightUp,
          detailURL: 'http://dev.kcssz.cloud.kingdee.com/index/partner/home',
        },
        created: function () {
          this.getEnergy();
          this.getAllCounts();
          this.getPartnerList();
        },
        mounted() {
          od = new Odometer({
            el: this.$refs.energyValue,
            value: 268,
            duration: 1000,
            format: 'd',
            theme: 'train-station',
          });

          if (isLightUp) {
            // 去掉增加能量值动效
            const addEnergyEffect = this.$refs.addEnergyEffect;
            addEnergyEffect.parentElement.removeChild(addEnergyEffect);
          }
        },
        methods: {
          // 查询伙伴列表
          getPartnerList: function () {
            axios
              .get('/kd/ecos/partner/queryall')
              .then((response) => {
                if (response.status === 200 && response.data.code === 200) {
                  const partnerList = response.data.data;

                  // 处理前三轮播放，1:3:3的比例
                  const level1PartnerList = [];
                  const level2PartnerList = [];
                  const level3PartnerList = [];
                  const deleteArr = [];
                  const round = 3;
                  for (let i = 0; i < partnerList.length; i++) {
                    const partner = partnerList[i];
                    if (partner.partnerLevel == 1 && level1PartnerList.length < round) {
                      level1PartnerList.push(partner);
                      deleteArr.push(i);
                    }
                    if (partner.partnerLevel == 2 && level2PartnerList.length < round * 3) {
                      level2PartnerList.push(partner);
                      deleteArr.push(i);
                    }
                    if (partner.partnerLevel == 3 && level3PartnerList.length < round * 3) {
                      level3PartnerList.push(partner);
                      deleteArr.push(i);
                    }
                    if (
                      level1PartnerList.length === round &&
                      level2PartnerList.length === round * 3 &&
                      level3PartnerList.length === round * 3
                    ) {
                      break;
                    }
                  }
                  deleteArr.forEach((index) => {
                    partnerList.splice(index, 1);
                  });
                  for (let i = 0; i < round; i++) {
                    for (let j = 0; j < 7; j++) {
                      if (j === 6 && level1PartnerList.length > 0) {
                        partnerList.unshift(level1PartnerList.pop());
                      } else if (j % 2 === 1 && level2PartnerList.length > 0) {
                        partnerList.unshift(level2PartnerList.pop());
                      } else if (level3PartnerList.length > 0) {
                        partnerList.unshift(level3PartnerList.pop());
                      }
                    }
                  }

                  // 把最终结果赋值给 this.partnerList
                  this.partnerList = partnerList;

                  if (isLightUp) {
                    // 伙伴列表轮播
                    this.playPartnerList();
                  }
                }
              })
              .catch((error) => {
                console.log(error);
              });
          },

          // 查询总开发者人数
          getAllCounts: function () {
            axios
              .get('/kd/ecos/partner/getdevcounts')
              .then((response) => {
                if (response.status === 200 && response.data.code === 200) {
                  const { devCounts, partnerCounts, prodCounts } = response.data.data;
                  this.devCounts = [1, 0, 0, 0, 0, '+'] || devCounts;
                  this.partnerCounts = [5, 0, 0, 0, '+'] || String(partnerCounts).split('');
                  this.prodCounts = String(prodCounts).split('');
                }
              })
              .catch((error) => {
                console.log(error);
              });
          },

          // 获取能量值
          getEnergy: function () {
            axios
              .get('/kd/ecos/production/geteneryvalue')
              .then((response) => {
                if (response.status === 200 && response.data.code === 200) {
                  od.update(response.data.data);
                }
              })
              .catch((error) => {
                console.log(error);
              });
          },

          // 增加能量值
          addEnergy: function () {
            axios
              .get('/kd/ecos/production/eneryvalue')
              .then((response) => {
                if (response.status === 200 && response.data.code === 200) {
                  od.update(response.data.data);
                }
              })
              .catch((error) => {
                console.log(error);
              });
          },

          //点亮生态树
          handleLightUp: function () {
            if (!isLightUp) {
              // 取消星星闪烁动画
              cancelAnimationFrame(rafG);

              // 开始星星的聚合动画
              generateFousPos();
              polymeric();

              // 取消星星的聚合动画
              setTimeout(() => {
                cancelAnimationFrame(rafP);
                bgGlink();
              }, 800);

              // 去除点亮生态树按钮动效，设置点亮状态
              tree.style.visibility = 'visible';
              isLightUp = true;
              this.isLightUp = true;
              lottieContainer.parentElement.removeChild(lottieContainer);
              cloudStar.className = 'lightup';

              // 伙伴列表轮播
              this.playPartnerList();

              // 增加能量值
              this.addEnergy();
            }
          },

          playPartnerList: function () {
            console.log('currentRound: ', this.currentRound);
            const roundNumber = 7;
            const currentPartnerList = [];

            // 三组伙伴轮播位置布局
            const partnerPosArr = [
              [
                { left: 100, top: 100 },
                { left: 600, top: 300 },
                { left: 220, top: 220 },
                { left: 320, top: 20 },
                { left: 500, top: 200 },
                { left: 400, top: 360 },
                { left: 0, top: 300 },
              ],
              [
                { left: 120, top: 400 },
                { left: 500, top: 120 },
                { left: 300, top: 200 },
                { left: 200, top: 60 },
                { left: 600, top: 300 },
                { left: 20, top: 180 },
                { left: 420, top: 340 },
              ],
              [
                { left: 300, top: 330 },
                { left: 350, top: 0 },
                { left: 500, top: 100 },
                { left: 250, top: 150 },
                { left: 10, top: 250 },
                { left: 100, top: 400 },
                { left: 600, top: 350 },
              ],
            ];

            for (let i = 0; i < 7; i++) {
              const currrentPartner = this.partnerList[this.currentRound * roundNumber + i];

              // 设置伙伴球的位置
              const { left, top } = partnerPosArr[this.currentRound % 3][i];
              currrentPartner.left = left;
              currrentPartner.top = top;

              // 设置伙伴球的尺寸
              const sizeArr = [70, 80, 90, 100];
              const randomNumber = Math.floor(Math.random() * 7);
              let size = 80;
              if (randomNumber === 0) size = 70;
              if (randomNumber === 1) size = 90;
              if (randomNumber === 2) size = 100;
              currrentPartner.size = size;

              currentPartnerList.push(currrentPartner);
            }

            this.currentPartnerList = currentPartnerList;
            setTimeout(() => {
              this.fadeIn = true;
              this.currentRound += 1;

              this.playPartnerInfo();
            }, 0);
          },

          playPartnerInfo: function () {
            this.infoFadeIn = true;
            this.partnerInfo = this.currentPartnerList[this.partnerIndex];
            if (this.partnerIndex < 7) {
              console.log('partnerIndex: ', this.partnerIndex);
              this.partnerIndex += 1;
              this.timer1 = setTimeout(() => {
                this.infoFadeIn = false;
                this.timer2 = setTimeout(() => {
                  this.playPartnerInfo();
                }, 200);
              }, 1000 * 3);
            } else {
              this.fadeIn = false;
              this.partnerIndex = 0;

              this.currentPartnerList.forEach((partner) => {
                partner.left = treeRect.width / 2;
                partner.top = treeRect.height / 2;
              });

              this.timer3 = setTimeout(() => {
                this.playPartnerList();
              }, 1000);
            }
          },

          handleMouseEnter: function (index) {
            console.log('partnerIndex: ', index);
            if (this.fadeIn) {
              this.timer1 && clearInterval(this.timer1);
              this.timer2 && clearInterval(this.timer2);
              this.timer3 && clearInterval(this.timer3);
              this.timer1 = setTimeout(() => {
                this.infoFadeIn = false;
                this.partnerInfo = this.currentPartnerList[index];
                this.timer2 = setTimeout(() => {
                  this.infoFadeIn = true;
                }, 200);
              }, 500);
            }
          },

          handleMouseLeave: function () {
            if (this.fadeIn) {
              this.timer1 && clearInterval(this.timer1);
              this.timer2 && clearInterval(this.timer2);
              this.infoFadeIn = false;
              this.timer2 = setTimeout(() => {
                this.playPartnerInfo();
              }, 500);
            }
          },
        },
      });
    </script>
  </body>
</html>
